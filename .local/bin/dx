#!/bin/bash

# Interactive Distrobox Entry Script
# Requires: distrobox, fzf

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Function to display error and exit
error_exit() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

# Check if distrobox is installed
if ! command -v distrobox &> /dev/null; then
    error_exit "distrobox is not installed"
fi

# Check if fzf is installed
if ! command -v fzf &> /dev/null; then
    echo -e "${RED}Error: fzf is not installed${NC}" >&2
    echo -e "${YELLOW}Install with:${NC}" >&2
    echo -e "  ${CYAN}Fedora/RHEL:${NC} sudo dnf install fzf" >&2
    echo -e "  ${CYAN}Debian/Ubuntu:${NC} sudo apt install fzf" >&2
    echo -e "  ${CYAN}Arch:${NC} sudo pacman -S fzf" >&2
    echo -e "  ${CYAN}macOS:${NC} brew install fzf" >&2
    exit 1
fi

# Get list of distrobox containers (silently)
containers=$(distrobox list --no-color 2>/dev/null | tail -n +2)

# Check if any containers exist
if [ -z "$containers" ]; then
    echo -e "${RED}No distrobox containers found${NC}" >&2
    echo -e "${YELLOW}Create one with:${NC}" >&2
    echo -e "  ${CYAN}distrobox create --name <n> --image <image>${NC}" >&2
    echo "" >&2
    echo -e "${YELLOW}Popular images:${NC}" >&2
    echo -e "  ${CYAN}Ubuntu:${NC} ubuntu:latest" >&2
    echo -e "  ${CYAN}Fedora:${NC} fedora:latest" >&2
    echo -e "  ${CYAN}Arch:${NC} archlinux:latest" >&2
    echo -e "  ${CYAN}Alpine:${NC} alpine:latest" >&2
    echo -e "  ${CYAN}Debian:${NC} debian:latest" >&2
    echo "" >&2
    echo -e "${YELLOW}Example:${NC}" >&2
    echo -e "  ${CYAN}distrobox create --name dev-ubuntu --image ubuntu:latest${NC}" >&2
    exit 1
fi

# Count containers
container_count=$(echo "$containers" | wc -l)

# If only one container exists, enter it immediately
if [ "$container_count" -eq 1 ]; then
    # Extract the container name (distrobox list uses | as field separator)
    # Format: ID | NAME | STATUS | IMAGE
    container_name=$(echo "$containers" | awk -F'|' '{gsub(/^[ \t]+|[ \t]+$/, "", $2); print $2}')
    exec distrobox enter "$container_name"
fi

# Parse container list and prepare for fzf
# Extract and format: NAME | STATUS | IMAGE
container_list=$(echo "$containers" | awk -F'|' '{
    gsub(/^[ \t]+|[ \t]+$/, "", $2);
    gsub(/^[ \t]+|[ \t]+$/, "", $3);
    gsub(/^[ \t]+|[ \t]+$/, "", $4);
    print $2 " | " $3 " | " $4
}')

# Use fzf to select a container
selected=$(echo "$container_list" | fzf \
    --height=40% \
    --border \
    --prompt="Select container: " \
    --header="↑↓ navigate • type to filter • Enter to select • Esc to cancel" \
    --preview='echo "Container: {1}\nStatus: {3}\nImage: {5}"' \
    --preview-window=up:3:wrap \
    --bind='ctrl-r:reload(distrobox list --no-color 2>/dev/null | tail -n +2 | awk "{print \$2 \" | \" \$3 \" | \" \$4}")' \
    --header-first)

# Check if selection was made (user pressed Esc)
if [ -z "$selected" ]; then
    exit 0
fi

# Extract container name (first field)
container_name=$(echo "$selected" | awk '{print $1}')

# Enter the selected container
exec distrobox enter "$container_name"
